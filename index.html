<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Player - Fixed Navigation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root { --primary: #1db954; --bg: #121212; --card: #181818; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        .sidebar { width: 320px; background: #000; display: flex; flex-direction: column; border-right: 1px solid #282828; }
        .sidebar h3 { padding: 20px; margin: 0; }
        #playlist { list-style: none; padding: 0; overflow-y: auto; flex-grow: 1; margin: 0; }
        #playlist li { padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #222; font-size: 13px; transition: 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #playlist li:hover { background: #282828; }
        #playlist li.active { color: var(--primary); background: #1a1a1a; border-left: 4px solid var(--primary); }

        .main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .player-card { background: var(--card); padding: 40px; border-radius: 20px; width: 100%; max-width: 450px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.6); }
        
        .playback-controls { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 25px 0; }
        .btn-main { background: none; border: none; color: white; font-size: 24px; cursor: pointer; transition: 0.2s; }
        .btn-play { background: white; color: black; width: 50px; height: 50px; border-radius: 50%; font-size: 20px; display: flex; align-items: center; justify-content: center; }

        .effects-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; }
        button.btn-effect { padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; background: #282828; color: #bbb; }
        button.btn-effect.active { background: var(--primary); color: white; font-weight: bold; }

        .btn-upload { background: var(--primary); color: white; margin: 15px; padding: 10px; border-radius: 20px; font-size: 12px; border:none; cursor:pointer;}
        #songTitle { margin: 0; font-size: 1.2rem; height: 1.5em; overflow: hidden; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>Library</h3>
        <a href="indexv2.html">v2</a>
        <input type="file" id="folderInput" webkitdirectory style="display:none">
        <button class="btn-upload" onclick="document.getElementById('folderInput').click()">üìÅ Buka Folder Musik</button>
        <ul id="playlist">
            <li style="color:#666; text-align:center;">Folder belum dipilih</li>
        </ul>
    </div>

    <div class="main">
        <div class="player-card">
            <p style="color: var(--primary); font-size: 10px; font-weight: bold; letter-spacing: 2px;">WEB AI PROCESSOR</p>
            <h2 id="songTitle">---</h2>
            
            <div class="playback-controls">
                <button class="btn-main" onclick="handleManualPrev()">‚èÆ</button>
                <button class="btn-main btn-play" id="masterPlay" onclick="togglePlay()">‚ñ∂</button>
                <button class="btn-main" onclick="handleManualNext()">‚è≠</button>
            </div>

            <p style="font-size: 11px; color: #888;">Modifikasi Suara Vokal:</p>
            <div class="effects-grid">
                <button class="btn-effect active" onclick="setEffect('normal', this)">Normal</button>
                <button class="btn-effect" onclick="setEffect('female', this)">üë© Perempuan</button>
                <button class="btn-effect" onclick="setEffect('child', this)">üë∂ Anak Kecil</button>
                <button class="btn-effect" onclick="setEffect('cat', this)">üê± Cat</button>
                <button class="btn-effect" onclick="setEffect('monster', this)">üëπ Monster</button>
                <button class="btn-effect" onclick="setEffect('robot', this)">ü§ñ Robot</button>
            </div>
            
            <p id="statusMsg" style="font-size: 11px; color: #555; margin-top: 15px;">Auto-play: ON</p>
        </div>
    </div>

    <script>
        const limiter = new Tone.Limiter(-1).toDestination();
        const vibrato = new Tone.Vibrato(0, 0).connect(limiter);
        const pitchShift = new Tone.PitchShift({ pitch: 0, windowSize: 0.1 }).connect(vibrato);
        const filter = new Tone.Filter(20000, "lowpass").connect(limiter);
        
        let player = new Tone.Player().connect(pitchShift);
        
        let songFiles = [];
        let currentIndex = -1;
        let isChangingSong = false; // Flag kunci untuk menghentikan looping Next

        // Efek transisi otomatis saat lagu habis
        player.onstop = () => {
            // Jika lagu berhenti secara alami (bukan karena diklik Next/Prev)
            if (!isChangingSong && player.state === "stopped") {
                console.log("Lagu selesai secara alami. Memutar lagu berikutnya...");
                playNext();
            }
        };

        document.getElementById('folderInput').addEventListener('change', (e) => {
            const files = Array.from(e.target.files).filter(f => f.type.startsWith('audio/'));
            if (files.length === 0) return;
            songFiles = files;
            renderPlaylist();
        });

        function renderPlaylist() {
            const list = document.getElementById('playlist');
            list.innerHTML = '';
            songFiles.forEach((file, i) => {
                const li = document.createElement('li');
                li.innerText = file.name;
                li.onclick = () => playSong(i);
                list.appendChild(li);
            });
        }

        async function playSong(index) {
            if (index < 0 || index >= songFiles.length) return;
            
            isChangingSong = true; // KUNCI: Beritahu sistem bahwa kita sedang pindah lagu
            player.stop();
            
            currentIndex = index;
            await Tone.start();

            const file = songFiles[index];
            const url = URL.createObjectURL(file);
            document.getElementById('songTitle').innerText = file.name;

            updateActiveUI();

            player.load(url).then(() => {
                isChangingSong = false; // Buka kunci setelah lagu baru siap
                player.start();
                document.getElementById('masterPlay').innerText = "‚è∏";
                document.getElementById('statusMsg').innerText = "Playing...";
            }).catch(e => {
                isChangingSong = false;
                console.error("Gagal load lagu", e);
            });
        }

        // Fungsi pembungkus untuk navigasi manual agar tidak konflik dengan auto-play
        function handleManualNext() {
            playNext();
        }

        function handleManualPrev() {
            playPrev();
        }

        function playNext() {
            let next = (currentIndex + 1) % songFiles.length;
            playSong(next);
        }

        function playPrev() {
            let prev = (currentIndex - 1 + songFiles.length) % songFiles.length;
            playSong(prev);
        }

        function togglePlay() {
            if (player.state === "started") {
                player.pause();
                document.getElementById('masterPlay').innerText = "‚ñ∂";
            } else {
                player.play();
                document.getElementById('masterPlay').innerText = "‚è∏";
            }
        }

        function updateActiveUI() {
            document.querySelectorAll('#playlist li').forEach((li, i) => {
                li.className = (i === currentIndex) ? 'active' : '';
            });
        }

        // --- MODEL SUARA TERMASUK PEREMPUAN ---
        function setEffect(type, btn) {
            // Reset ke Normal
            pitchShift.pitch = 0;
            vibrato.wet.value = 0;
            filter.frequency.value = 20000;
            player.playbackRate = 1.0;
            pitchShift.windowSize = 0.1;

            if (type === 'female') {
                // Suara Perempuan: Pitch naik medium, filter high-pass sedikit agar lebih tipis
                pitchShift.pitch = 5.5; 
                pitchShift.windowSize = 0.15; // Lebih soft
                filter.type = "highpass";
                filter.frequency.value = 200; // Buang suara bass vokal yang berat
            }
            else if (type === 'child') {
                pitchShift.pitch = 8;
                pitchShift.windowSize = 0.05;
            } 
            else if (type === 'cat') {
                pitchShift.pitch = 10;
                vibrato.wet.value = 1;
                vibrato.frequency.value = 2; 
                vibrato.depth.value = 0.8;
            } 
            else if (type === 'monster') {
                pitchShift.pitch = -7;
                filter.type = "lowpass";
                filter.frequency.value = 1000;
            }
            else if (type === 'robot') {
                // Gunakan vibrato kaku untuk efek robotik
                vibrato.wet.value = 1;
                vibrato.frequency.value = 50; 
                vibrato.depth.value = 1;
            }

            document.querySelectorAll('.btn-effect').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    </script>
</body>

</html>
